#!/usr/bin/env node

/*
 * Set auryn parameters in dock config files (xml or plist)
 */


/**
 * Module dependencies.
 */

var _ = require('lodash');
var async = require('async');
var auryn = require('../package.json');
var cheerio = require('cheerio');
var config = require('../lib/config');
var fs = require('fs');
var program = require('commander');


program
  .version(auryn.version)
  .option('-m, --android-manifest [file]', 'Autoconfigure an Android manifest')
  .option('-p, --project-path [path]', 'Choose another path than current', '.')
  .parse(process.argv);

var steps = {};
var manifestSteps = {};


manifestSteps.readConfig = function (next) {
  config.get('android.manifest', {projectPath: program.projectPath}, next);
};

manifestSteps.readManifest = function (conf, next) {
  fs.readFile(program.androidManifest, 'utf8', function (err, raw) {
    next(err, conf, raw);
  });
};

manifestSteps.editXML = function (conf, raw, next) {
  var $ = cheerio.load(raw);

  _.each(conf.rules, function (rule, selector) {
    var $el = $(selector);

    _.each(rule.attrs, function (value, name) {
      $el.attr(name, value);
    });

  });

  fs.writeFile(program.androidManifest, $.xml());
};

if (program.androidManifest) {
  steps = manifestSteps;
}

async.waterfall(_.values(steps), function (err) {
  if (err) {
    console.error(err);
    process.exit(1);
  }
});